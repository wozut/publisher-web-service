#!/bin/bash

# Pre-push hook that runs quality checks only when pushing to main branch

protected_branch='main'
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Only run checks if pushing to main branch
if [ "$current_branch" = "$protected_branch" ]; then
    echo "🔍 Running pre-push checks for main branch..."
    
    # Check if branch is up-to-date with remote
    echo "🌐 Checking if branch is up-to-date with remote..."
    git fetch origin "$protected_branch" --quiet

    # Check if there are commits on remote that we don't have locally
    behind_count=$(git rev-list --count HEAD..origin/"$protected_branch")

    if [ "$behind_count" -gt 0 ]; then
        echo "❌ Branch is $behind_count commit(s) behind origin/$protected_branch. Please pull latest changes first."
        exit 1
    fi
    echo "✅ Branch is up-to-date with remote"

    # Run build
    echo "🔨 Building project with Gradle..."
    if ! ./gradlew build; then
        echo "❌ Build failed. Please fix build errors before pushing."
        exit 1
    fi
    echo "✅ Build successful"
    
    # Build Docker image
    echo "🐳 Building Docker image..."
    if ! docker build \
      --build-arg JAR_FILE=spring-boot/build/libs/spring-boot.jar \
      -t latest \
      --platform=linux/amd64 \
      .; then
        echo "❌ Docker build failed. Please fix Docker build errors before pushing."
        exit 1
    fi
    echo "✅ Docker build successful"
    
    echo "🎉 All pre-push checks passed! Push to main allowed."
else
    echo "ℹ️  Skipping pre-push checks (not pushing to main branch)"
fi