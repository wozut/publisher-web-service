#!/bin/bash

# Pre-push hook that runs quality checks only when pushing to main branch

protected_branch='main'
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Only run checks if pushing to main branch
if [ "$current_branch" = "$protected_branch" ]; then
    echo "ğŸ” Running pre-push checks for main branch..."
    
    # Run build
    echo "ğŸ”¨ Building project with Gradle..."
    if ! ./gradlew build; then
        echo "âŒ Build failed. Please fix build errors before pushing."
        exit 1
    fi
    echo "âœ… Build successful"
    
    # Build Docker image
    echo "ğŸ³ Building Docker image..."
    if ! docker build \
      --build-arg JAR_FILE=spring-boot/build/libs/spring-boot.jar \
      -t latest \
      --platform=linux/amd64 \
      .; then
        echo "âŒ Docker build failed. Please fix Docker build errors before pushing."
        exit 1
    fi
    echo "âœ… Docker build successful"
    
    echo "ğŸ‰ All pre-push checks passed! Push to main allowed."
else
    echo "â„¹ï¸  Skipping pre-push checks (not pushing to main branch)"
fi